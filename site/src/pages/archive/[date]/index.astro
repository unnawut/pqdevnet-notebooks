---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Icon from '../../../components/Icon.astro';
import yaml from 'js-yaml';
import fs from 'node:fs';
import path from 'node:path';

// Load notebooks config from pipeline.yaml
const configPath = path.join(process.cwd(), '..', 'pipeline.yaml');
const configContent = fs.readFileSync(configPath, 'utf-8');
const config = yaml.load(configContent) as {
  notebooks: Array<{
    id: string;
    title: string;
    description: string;
    icon?: string;
    order: number;
  }>;
};

// Load manifest
const manifestPath = path.join(process.cwd(), 'public', 'rendered', 'manifest.json');
let manifest: { dates: Record<string, Record<string, unknown>> } = { dates: {} };
if (fs.existsSync(manifestPath)) {
  manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf-8'));
}

export function getStaticPaths() {
  const manifestPath = path.join(process.cwd(), 'public', 'rendered', 'manifest.json');
  if (!fs.existsSync(manifestPath)) {
    return [];
  }
  const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf-8'));
  const dates = Object.keys(manifest.dates || {});

  return dates.map((date) => ({
    params: { date },
  }));
}

const { date } = Astro.params;
const dateData = manifest.dates[date!] || {};
const notebooks = config.notebooks.sort((a, b) => a.order - b.order);

// Filter to notebooks that have been rendered for this date
const availableNotebooks = notebooks.filter((nb) => dateData[nb.id]);

// Get all dates for navigation
const allDates = Object.keys(manifest.dates).sort((a, b) => b.localeCompare(a));
const currentIndex = allDates.indexOf(date!);
const prevDate = currentIndex < allDates.length - 1 ? allDates[currentIndex + 1] : null;
const nextDate = currentIndex > 0 ? allDates[currentIndex - 1] : null;

// Format date for display
const dateObj = new Date(date + 'T00:00:00Z');
const formattedDate = dateObj.toLocaleDateString('en-US', {
  weekday: 'long',
  month: 'long',
  day: 'numeric',
  year: 'numeric',
  timeZone: 'UTC',
});
const dayOfWeek = dateObj.toLocaleDateString('en-US', { weekday: 'short', timeZone: 'UTC' });
const monthShort = dateObj.toLocaleDateString('en-US', { month: 'short', timeZone: 'UTC' });
const dayNum = dateObj.getDate();
const year = dateObj.getFullYear();
---

<BaseLayout title={`Archive: ${date}`}>
  <div class="archive-date-page">
    <!-- Breadcrumb -->
    <nav class="breadcrumb">
      <a href="/" class="breadcrumb-link">
        <Icon name="Home" size={14} />
        <span>Home</span>
      </a>
      <span class="breadcrumb-sep">/</span>
      <a href="/archive" class="breadcrumb-link">Archive</a>
      <span class="breadcrumb-sep">/</span>
      <span class="breadcrumb-current">{date}</span>
    </nav>

    <!-- Header -->
    <header class="date-header">
      <div class="date-display">
        <div class="date-calendar">
          <span class="date-month">{monthShort}</span>
          <span class="date-day">{dayNum}</span>
          <span class="date-year">{year}</span>
        </div>
        <div class="date-info">
          <span class="date-weekday">{dayOfWeek}</span>
          <h1 class="date-title">Snapshot Archive</h1>
          <p class="date-subtitle">{formattedDate}</p>
        </div>
      </div>
    </header>

    <!-- Stats bar -->
    <div class="stats-bar">
      <div class="stat">
        <span class="stat-value">{availableNotebooks.length}</span>
        <span class="stat-label">Notebooks</span>
      </div>
      <div class="stat-divider"></div>
      <div class="stat">
        <span class="stat-value">{date}</span>
        <span class="stat-label">Snapshot Date</span>
      </div>
    </div>

    <!-- Navigation arrows -->
    <div class="date-nav">
      {
        prevDate ? (
          <a href={`/archive/${prevDate}`} class="nav-arrow nav-prev">
            <Icon name="ChevronLeft" size={16} />
            <span class="nav-label">
              <span class="nav-hint">Previous</span>
              <span class="nav-date">{prevDate}</span>
            </span>
          </a>
        ) : (
          <div class="nav-placeholder" />
        )
      }

      {
        nextDate ? (
          <a href={`/archive/${nextDate}`} class="nav-arrow nav-next">
            <span class="nav-label">
              <span class="nav-hint">Next</span>
              <span class="nav-date">{nextDate}</span>
            </span>
            <Icon name="ChevronRight" size={16} />
          </a>
        ) : (
          <div class="nav-placeholder" />
        )
      }
    </div>

    <!-- Notebooks section -->
    <section class="notebooks-section">
      <h2 class="section-title">
        <span class="section-title-text">Available Notebooks</span>
        <span class="section-title-line"></span>
      </h2>

      {
        availableNotebooks.length > 0 ? (
          <div class="notebooks-grid">
            {availableNotebooks.map((nb, index) => (
              <a href={`/archive/${date}/${nb.id}`} class="notebook-card" style={`--delay: ${index * 0.08}s`}>
                <div class="notebook-icon">
                  <Icon name={nb.icon || 'FileText'} size={24} />
                </div>
                <div class="notebook-content">
                  <h3 class="notebook-title">{nb.title}</h3>
                  <p class="notebook-description">{nb.description}</p>
                </div>
                <div class="notebook-arrow">
                  <Icon name="ArrowRight" size={18} />
                </div>
                <div class="notebook-glow" />
              </a>
            ))}
          </div>
        ) : (
          <div class="empty-state">
            <div class="empty-icon">
              <Icon name="FilePlus" size={48} strokeWidth={1} />
            </div>
            <h3 class="empty-title">No Notebooks Available</h3>
            <p class="empty-text">No analysis notebooks have been rendered for this date.</p>
            <a href="/archive" class="empty-link">
              Browse other dates
            </a>
          </div>
        )
      }
    </section>

    <!-- Back link -->
    <div class="back-section">
      <a href="/archive" class="back-link">
        <Icon name="ArrowLeft" size={16} />
        <span>Back to Archive</span>
      </a>
    </div>
  </div>
</BaseLayout>

<style>
  @reference "../../../styles/global.css";

  .archive-date-page {
    @apply max-w-3xl;
    animation: fadeUp 0.5s ease-out;
  }

  /* Breadcrumb */
  .breadcrumb {
    @apply mb-8 flex items-center gap-2 font-mono text-sm;
  }

  .breadcrumb-link {
    @apply text-muted-foreground flex items-center gap-1.5 no-underline transition-colors duration-200;
  }

  .breadcrumb-link:hover {
    @apply text-foreground;
  }

  .breadcrumb-sep {
    @apply text-border;
  }

  .breadcrumb-current {
    @apply text-foreground font-medium;
  }

  /* Header */
  .date-header {
    @apply mb-8 pb-8;
  }

  .date-display {
    @apply flex items-center gap-6;
  }

  .date-calendar {
    @apply border-primary bg-primary/5 flex h-24 w-20 flex-col items-center justify-center border-2;
    animation: fadeUp 0.4s ease-out 0.1s backwards;
  }

  :global(.dark) .date-calendar {
    @apply bg-primary/10;
  }

  .date-month {
    @apply text-primary font-mono text-xs font-bold tracking-wider uppercase;
  }

  .date-day {
    @apply text-foreground font-serif text-3xl leading-none font-normal -tracking-tight;
  }

  .date-year {
    @apply text-muted-foreground font-mono text-xs;
  }

  .date-info {
    @apply flex flex-col;
    animation: fadeUp 0.4s ease-out 0.15s backwards;
  }

  .date-weekday {
    @apply text-primary mb-1 font-mono text-xs font-semibold tracking-widest uppercase;
  }

  .date-title {
    @apply text-foreground m-0 mb-1 font-serif text-3xl leading-tight font-normal -tracking-wide;
  }

  .date-subtitle {
    @apply text-muted-foreground m-0 font-sans text-sm;
  }

  /* Stats bar */
  .stats-bar {
    @apply bg-muted/50 border-border mb-6 flex items-center gap-6 border px-6 py-4;
    animation: fadeUp 0.4s ease-out 0.25s backwards;
  }

  .stat {
    @apply flex items-baseline gap-2;
  }

  .stat-value {
    @apply text-foreground font-mono text-lg font-semibold;
  }

  .stat-label {
    @apply text-muted-foreground font-mono text-xs tracking-wider uppercase;
  }

  .stat-divider {
    @apply bg-border h-6 w-px;
  }

  /* Date navigation */
  .date-nav {
    @apply mb-10 flex items-center justify-between gap-4;
    animation: fadeUp 0.4s ease-out 0.3s backwards;
  }

  .nav-arrow {
    @apply text-muted-foreground flex items-center gap-2 px-3 py-2 no-underline transition-all duration-200;
  }

  .nav-arrow:hover {
    @apply text-foreground bg-muted;
  }

  .nav-prev {
    @apply pr-4;
  }

  .nav-next {
    @apply pl-4 text-right;
  }

  .nav-label {
    @apply flex flex-col;
  }

  .nav-hint {
    @apply text-xs tracking-wider uppercase opacity-60;
  }

  .nav-date {
    @apply font-mono text-sm;
  }

  .nav-placeholder {
    @apply w-32;
  }

  /* Section */
  .notebooks-section {
    @apply mb-12;
    animation: fadeUp 0.4s ease-out 0.35s backwards;
  }

  .section-title {
    @apply text-foreground m-0 mb-6 flex items-center gap-4 font-serif text-xl font-normal;
  }

  .section-title-text {
    @apply shrink-0;
  }

  .section-title-line {
    @apply bg-border h-px flex-1;
  }

  /* Notebooks grid */
  .notebooks-grid {
    @apply flex flex-col gap-3;
  }

  .notebook-card {
    @apply border-border bg-card relative flex items-center gap-5 overflow-hidden border p-5 no-underline transition-all duration-250;
    animation: fadeUp 0.4s ease-out calc(0.4s + var(--delay)) backwards;
  }

  .notebook-card:hover {
    @apply border-primary -translate-y-0.5;
    box-shadow: 0 8px 30px oklch(0 0 0 / 8%);
  }

  :global(.dark) .notebook-card:hover {
    @apply bg-[oklch(0.16_0.02_260)];
    box-shadow: 0 8px 30px oklch(0.55 0.12 280 / 15%);
  }

  .notebook-icon {
    @apply bg-primary/10 text-primary flex h-12 w-12 shrink-0 items-center justify-center transition-all duration-250;
  }

  .notebook-card:hover .notebook-icon {
    @apply bg-primary text-primary-foreground scale-110;
  }

  .notebook-content {
    @apply min-w-0 flex-1;
  }

  .notebook-title {
    @apply text-foreground m-0 mb-1 font-serif text-lg leading-snug font-normal;
  }

  .notebook-description {
    @apply text-muted-foreground m-0 line-clamp-2 text-sm leading-relaxed;
  }

  .notebook-arrow {
    @apply text-muted-foreground flex h-10 w-10 -translate-x-2 items-center justify-center opacity-0 transition-all duration-250;
  }

  .notebook-card:hover .notebook-arrow {
    @apply text-primary translate-x-0 opacity-100;
  }

  .notebook-glow {
    @apply pointer-events-none absolute inset-0 opacity-0 transition-opacity duration-300;
    background: radial-gradient(circle at 50% 50%, oklch(0.6 0.15 280 / 8%) 0%, transparent 70%);
  }

  .notebook-card:hover .notebook-glow {
    @apply opacity-100;
  }

  /* Empty state */
  .empty-state {
    @apply bg-muted/50 border-border border px-8 py-16 text-center;
  }

  .empty-icon {
    @apply text-muted-foreground mb-6 inline-flex opacity-40;
  }

  .empty-title {
    @apply text-foreground m-0 mb-2 font-serif text-xl font-normal;
  }

  .empty-text {
    @apply text-muted-foreground m-0 mb-6 text-sm;
  }

  .empty-link {
    @apply text-primary inline-flex items-center gap-2 font-mono text-sm no-underline transition-colors duration-200;
  }

  .empty-link:hover {
    @apply text-accent underline;
  }

  /* Back section */
  .back-section {
    @apply border-border border-t pt-8;
    animation: fadeUp 0.4s ease-out 0.5s backwards;
  }

  .back-link {
    @apply text-muted-foreground inline-flex items-center gap-2 font-mono text-sm no-underline transition-colors duration-200;
  }

  .back-link:hover {
    @apply text-foreground;
  }

  /* Responsive */
  @media (max-width: 640px) {
    .date-display {
      @apply gap-4;
    }

    .date-calendar {
      @apply h-20 w-16;
    }

    .date-day {
      @apply text-2xl;
    }

    .date-title {
      @apply text-2xl;
    }

    .stats-bar {
      @apply flex-col items-start gap-3 px-4 py-3;
    }

    .stat-divider {
      @apply h-px w-full;
    }

    .date-nav {
      @apply flex-col gap-2;
    }

    .nav-arrow {
      @apply w-full justify-between;
    }

    .nav-prev,
    .nav-next {
      @apply px-4;
    }

    .nav-placeholder {
      @apply hidden;
    }

    .notebook-card {
      @apply gap-4 p-4;
    }

    .notebook-icon {
      @apply h-10 w-10;
    }
  }
</style>
